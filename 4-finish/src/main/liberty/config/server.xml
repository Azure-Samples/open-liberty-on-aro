<?xml version="1.0" encoding="UTF-8"?>
<server description="defaultServer">
    <!-- Enable features -->
    <featureManager>
        <feature>cdi-2.0</feature>
        <feature>jaxb-2.2</feature>
        <feature>jsf-2.3</feature>
        <feature>jaxrs-2.1</feature>
        <feature>ejbLite-3.2</feature>
        <feature>jpa-2.2</feature>
        <feature>openidConnectClient-1.0</feature>
        <feature>transportSecurity-1.0</feature>
        <feature>appSecurity-3.0</feature>
        <feature>jwt-1.0</feature>
        <feature>mpJwt-1.1</feature>
        <feature>mpConfig-1.3</feature>
    </featureManager>

    <!-- Define http & https endpoints -->
    <httpEndpoint id="defaultHttpEndpoint" host="*"
        httpPort="9080" httpsPort="9443" />

    <!-- Automatically expand WAR files and EAR files -->
    <applicationManager autoExpand="true" />

    <!-- Define web application with its context root and location -->
    <webApplication id="javaee-cafe" contextRoot="/"
        location="${server.config.dir}/apps/javaee-cafe.war">
        <!-- Grant role "users" to all authenticated users -->
        <application-bnd>
            <security-role name="users">
                <special-subject type="ALL_AUTHENTICATED_USERS" />
            </security-role>
        </application-bnd>
    </webApplication>

    <!-- trust JDKâ€™s default truststore -->
    <ssl id="defaultSSLConfig"  trustDefaultCerts="true" />

    <!-- Add your tenant id, client ID and secret from AAD -->
    <openidConnectClient
        id="liberty-aad-oidc-javaeecafe" clientId="${client.id}"
        clientSecret="${client.secret}"
        discoveryEndpointUrl="https://login.microsoftonline.com/${tenant.id}/v2.0/.well-known/openid-configuration"
        signatureAlgorithm="RS256"
        userIdentityToCreateSubject="preferred_username"
        inboundPropagation="supported" />
    
    <!-- JWT builder -->
    <jwtBuilder id="jwtAuthUserBuilder" keyStoreRef="defaultKeyStore" 
        keyAlias="${key.alias}" issuer="https://example.com" expiresInSeconds="600" />
    <variable name="key.alias" defaultValue="default"/>

    <!-- JWT consumer -->
    <mpJwt id="jwtUserConsumer" jwksUri="https://localhost:9443/jwt/ibm/api/jwtAuthUserBuilder/jwk" 
        issuer="https://example.com" authFilterRef="mpJwtAuthFilter" />

    <!-- JWT auth filter -->
    <authFilter id="mpJwtAuthFilter">
        <requestUrl id="myRequestUrl" urlPattern="/rest" matchType="contains"/>
    </authFilter>

    <dataSource id="JavaEECafeDB" jndiName="jdbc/JavaEECafeDB">
        <jdbcDriver libraryRef="driver-library" />
        <properties.postgresql
            serverName="${db.server.name}"
            portNumber="${db.port.number}"
            databaseName="${db.name}"
            user="${db.user}"
            password="${db.password}"
            ssl="true" />
    </dataSource>

    <library id="driver-library">
        <fileset dir="${shared.resource.dir}" includes="*.jar" />
    </library>
</server>